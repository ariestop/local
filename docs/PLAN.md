# Детальный план реализации проекта

## Цель
Сформировать единый roadmap реализации продукта с понятными этапами, результатами и критериями готовности по backend, frontend, безопасности, данным, тестированию и релизу.

## База требований
- `README.md` — актуальный функционал и окружение запуска.
- `docs/ARCHITECTURE.md` — целевая архитектура и потоки данных.
- `docs/DATABASE.md` — схема и ограничения данных.
- `docs/CONVENTIONS.md` — инженерные соглашения и стандарты.

## Формат ведения плана
- Статусы: `Backlog`, `In Progress`, `Done`, `Risks`, `Decisions`.
- Каждая задача должна содержать: цель, зависимости, критерий готовности.
- Обновление статусов выполняется по завершению подэтапа, не пакетно в конце релиза.

## Текущий статус выполнения (2026-02-27)

### Done
1. Этап 0.1: Проверена и стабилизирована автозагрузка через явный PSR-4 маппинг в `composer.json` для фактической структуры каталогов.
2. Этап 0.2: Подтверждена матрица `APP_ENV` (`dev` — Debug Bar, `production` — без debug-инструментов) и синхронизирована документация.
3. Этап 0.3: Синхронизированы `README.md`, `AGENTS.md`, `docs/ARCHITECTURE.md`, `docs/CONVENTIONS.md`.
4. Этап 1.3: Нормализован JSON-контракт ошибок backend (`success/error/code`) для AJAX-ответов.
5. Этап 3.1: `public_html/assets/vue-app.js` декомпозирован на модули `vue/shared.js`, `vue/forms.js`, `vue/favorites.js`, `vue/gallery.js`.

### In Progress
1. Этап 1.2: Дальнейшая унификация server/client валидации по обязательным полям и лимитам фото.
2. Этап 2.3: Подготовка безопасной миграции legacy `md5` -> `password_hash` (план + миграция).

### Risks (актуализация)
- Риск регрессий на фронтенде после декомпозиции снижен модульной структурой, но требует smoke-проверки основных сценариев.

## Этап 0 — Стабилизация основы
**Цель:** закрепить техническую базу перед развитием фич.

### Backlog
1. Проверить PSR-4 консистентность после переименований (`Controllers`, `Core`, `Models`, `Services`).
2. Проверить корректность работы `APP_ENV` для `dev`/`production`.
3. Синхронизировать документацию по структуре каталогов и окружению.

### Deliverables
- Чистая автозагрузка Composer без PSR-4 предупреждений.
- Подтверждённая матрица окружений (`APP_ENV=dev` включает Debug Bar, production — нет).
- Актуальные документы без конфликтующих описаний структуры.

### Done-критерий
- Нет ошибок автозагрузки.
- Нет противоречий в `README.md`, `AGENTS.md`, `ARCHITECTURE.md`, `CONVENTIONS.md`.

## Этап 1 — Функциональная завершённость ядра объявлений
**Цель:** довести базовые пользовательские сценарии объявления до предсказуемого состояния.

### Backlog
1. Уточнить и закрепить CRUD-сценарии для объявлений (`add/edit/delete/detail/favorites`).
2. Унифицировать серверную и клиентскую валидацию (цена, обязательные поля, лимиты фото).
3. Нормализовать JSON-контракты ответов (`success/error/code`) и UX-сообщения.

### Deliverables
- Документированный и стабильный flow CRUD.
- Единые правила валидации и обработки ошибок.

### Done-критерий
- Все ключевые сценарии проходят smoke-проверку без расхождений поведения.

## Этап 2 — Аккаунт и безопасность
**Цель:** закрыть риски аутентификации/авторизации и безопасности форм.

### Backlog
1. Согласовать и завершить флоу регистрации, входа, восстановления пароля, подтверждения email.
2. Проверить CSRF-покрытие всех POST/AJAX маршрутов.
3. Подготовить и реализовать безопасную миграцию legacy `md5` к `password_hash`.

### Deliverables
- Единая политика безопасности по auth-потокам.
- План/реализация миграции паролей без ломающей совместимости.

### Done-критерий
- Уязвимости в auth-цепочке закрыты, все формы защищены CSRF.

## Этап 3 — Frontend качество и компонентность Vue
**Цель:** повысить поддерживаемость фронтенда без изменения бизнес-поведения.

### Backlog
1. Разделить `public_html/assets/vue-app.js` на функциональные модули (forms/favorites/gallery/shared).
2. Убрать остаточные inline-script зависимости, оставив только передачу данных.
3. Закрепить единый API-слой (`api.js`) и обработку ошибок.

### Deliverables
- Модульная структура фронтенда.
- Прозрачный контракт взаимодействия frontend/backend.

### Done-критерий
- Фронтенд код проще тестировать и расширять без регрессий.

## Этап 4 — Данные и БД
**Цель:** сделать схему БД полностью воспроизводимой и устойчивой.

### Backlog
1. Сверить фактические таблицы/индексы/ограничения с документацией (`favorite`, `post_photo` и др.).
2. Добавить/обновить миграции для полного приведения окружений.
3. Проверить целостность удаления объявлений и связанного контента (фото/избранное).

### Deliverables
- Актуальные миграции и корректная схема.
- Документированные связи и ограничения.

### Done-критерий
- Чистый разворот БД через `install.php + migrations` без ручных исправлений.

## Этап 5 — Тестирование и наблюдаемость
**Цель:** снизить риск регрессий и ускорить диагностику проблем.

### Backlog
1. Ввести минимальный smoke-набор критичных сценариев (auth, add/edit/delete, favorites).
2. Добавить проверки API-контрактов и валидаторов.
3. Стандартизировать логирование по слоям (`Controller/Service/Repository`).

### Deliverables
- Документированный тест-план.
- Повышенная наблюдаемость ошибок и упрощённый дебаг.

### Done-критерий
- Регрессии выявляются до релиза, ошибки диагностируются по логам.

## Этап 6 — Релизная готовность
**Цель:** обеспечить предсказуемый и безопасный выпуск в production.

### Backlog
1. Зафиксировать production-профиль (`APP_ENV=production`, dev-инструменты выключены).
2. Подготовить релизный чеклист (миграции, конфиг, бэкап, откат).
3. Описать runbook/операционные инструкции.

### Deliverables
- Повторяемая процедура релиза и отката.
- Документация для эксплуатации.

### Done-критерий
- Релиз выполняется по чеклисту с понятным rollback-процессом.

## Приоритет запуска этапов
1. Этап 0 -> Этап 1
2. Этап 2
3. Этап 3 и Этап 4 (параллельно)
4. Этап 5 -> Этап 6

## Risks
- Legacy-данные/пароли могут требовать поэтапной миграции.
- Скрытые расхождения между дампом БД и миграциями.
- Регрессии на фронтенде при декомпозиции `vue-app.js`.

## Decisions
- Debug-инструменты доступны только в `APP_ENV=dev`.
- PSR-4 соответствие каталогов — обязательное требование.
- Единый контракт JSON-ответов обязателен для всех AJAX endpoint'ов.
